import { __rest } from "tslib";
import { getAtomYaml } from './yaml';
import { FlashcardStatus } from './flashcard';
import { Quark } from './quark';
import * as fs from 'fs';
export class Atom extends Quark {
    constructor(_a) {
        var { topics = [], references = [], furtherDefinition = '', interestingFacts = '', keyConcepts = '', metaphor = '', furtherResearch = '', imageRef = '' } = _a, quarkProps = __rest(_a, ["topics", "references", "furtherDefinition", "interestingFacts", "keyConcepts", "metaphor", "furtherResearch", "imageRef"]);
        super(quarkProps);
        this.topics = topics;
        this.references = references;
        this.furtherDefinition = furtherDefinition;
        this.interestingFacts = interestingFacts;
        this.keyConcepts = keyConcepts;
        this.furtherResearch = furtherResearch;
        this.metaphor = metaphor;
        this.imageRef = imageRef;
    }
    imageTag() {
        return this.imageRef ? `![${this.name}](${this.imageRef})` : '';
    }
    generateAtomContent() {
        const flashcardSection = this.basicFlashcard.generateFlashcardSection('basic');
        const reverseFlashcardSection = this.reverseFlashcard.generateFlashcardSection('reverse');
        let imageTag = this.imageTag();
        let content = `${this.frontmatter()}${this.definition}---\n${imageTag}\n${this.furtherDefinition}\n\n${this.interestingFacts}\n\n${this.keyConcepts}\n\n${this.metaphor}\n\n${this.furtherResearch}\n`;
        if (this.createFlashcard) {
            content = content + flashcardSection;
        }
        if (this.createReverseFlashcard) {
            content = content + '\n\n---\n\n' + reverseFlashcardSection;
        }
        return content;
    }
    extractImageUrl(content) {
        const imageRegex = /!\[.*?\]\((https?:\/\/[^\s)]+)\)/;
        const match = content.match(imageRegex);
        return match ? match[1] : null;
    }
    /*     generateReverseFlashcardSection(): string {
            const rawDefinition = this.rawDefinition().trim()
            return `\n##### ${this.name}-Reverse #flashcard/reverse \nSTART\nBasic\n${rawDefinition}\nBack:\n${this.name}\n\nTARGET DECK: Brain::Atoms::Reverse`;
        } */
    isDirty() {
        let isDirty = false;
        // If the definition or name has changed, we need to update
        if ((this.createFlashcard || this.createReverseFlashcard) && (!this.flashcardInfo.includes(this.rawDefinition()) || (this.basicFlashcard.name != this.name))) {
            isDirty = true;
            console.log(`dirty check: ${this.flashcardInfo.includes(this.rawDefinition().trimStart().trimEnd())}`);
            console.log(this.flashcardInfo.indexOf(this.rawDefinition().trimStart().trimEnd()));
            console.log(this.flashcardInfo);
            console.log(this.rawDefinition().trimStart().trimEnd());
        }
        return isDirty;
    }
    frontmatter() {
        let topics = '';
        let references = '';
        if (this.topics.length > 0) {
            this.topics.forEach(element => {
                if (element && element.includes('[[') && element.includes(']]')) {
                    if (element.includes('"')) {
                        element = `'${element}'`;
                    }
                    else {
                        element = `"${element}"`;
                    }
                }
                topics += `\n- ${element}`;
            });
        }
        if (this.references.length > 0) {
            this.references.forEach(element => {
                if (element && element.includes('[[') && element.includes(']]')) {
                    if (element.includes('"')) {
                        element = `'${element}'`;
                    }
                    else {
                        element = `"${element}"`;
                    }
                }
                references += `\n- ${element}`;
            });
        }
        return `---\nname: ${this.name}\ntype: ${this.type}\ntopics: ${topics}\nreferences: ${references}\ncreateFlashcard: ${this.createFlashcard}\ncreateReverseFlashcard: ${this.createReverseFlashcard}\n---`;
    }
    populateFromFile(fileName, fileContent) {
        // Populate frontmatter properties
        const yamlData = getAtomYaml(fileContent);
        this.name = fileName.split('.')[0];
        this.type = (yamlData === null || yamlData === void 0 ? void 0 : yamlData.type) || '';
        this.topics = (yamlData === null || yamlData === void 0 ? void 0 : yamlData.topics) || [];
        this.references = (yamlData === null || yamlData === void 0 ? void 0 : yamlData.references) || [];
        this.createFlashcard = (yamlData === null || yamlData === void 0 ? void 0 : yamlData.createFlashcard) || false;
        this.createReverseFlashcard = (yamlData === null || yamlData === void 0 ? void 0 : yamlData.createReverseFlashcard) || false;
        // Populate main content sections
        const sections = fileContent.split("\n## ");
        this.definition = sections[0].split('---')[2] || '';
        this.furtherDefinition = `## ${this.removeSuccessiveNewlines(sections[1])}` || '';
        this.interestingFacts = `## ${this.removeSuccessiveNewlines(sections[2])}` || '';
        this.keyConcepts = `## ${this.removeSuccessiveNewlines(sections[3])}` || '';
        this.metaphor = `## ${this.removeSuccessiveNewlines(sections[4])}` || '';
        if (fileContent.includes('#flashcard')) {
            this.furtherResearch = `## ${this.removeSuccessiveNewlines(sections[5].split('######')[0])}` || '';
        }
        else {
            this.furtherResearch = `## ${sections[5]}` || '';
        }
        this.imageRef = this.extractImageUrl(fileContent) || '';
        // Populate flashcard sections
        const flashcardSection = sections[5];
        // Basic Flashcard
        this.flashcardInfo = flashcardSection.split('######')[1];
        if (this.flashcardInfo) {
            const flashcardDefinition = this.basicFlashcard.getFlashcardBack(this.flashcardInfo).replace(this.imageTag(), '').trim();
            if (flashcardDefinition == this.rawDefinition()) {
                this.basicFlashcard.status = FlashcardStatus.NO_CHANGE;
                this.basicFlashcard.populateFromExistingFlashcard('basic', this.name, this.flashcardInfo);
            }
            else {
                this.basicFlashcard.status = FlashcardStatus.CHANGE;
                this.basicFlashcard.populateNewFlashcard('basic', this.name, this.rawDefinition(), this.imageTag());
            }
        }
        else if (this.createFlashcard) {
            //console.log(`${this.name} does not have a basic flashcard`);
            this.basicFlashcard.populateNewFlashcard('basic', this.name, this.rawDefinition(), this.imageTag(), false);
        }
        // Reverse Flashcard
        this.reverseFlashcardInfo = flashcardSection.split('---')[2];
        if (this.reverseFlashcardInfo) {
            if (!this.basicFlashcard.isDirty()) {
                this.reverseFlashcard.populateFromExistingFlashcard('reverse', this.name, this.reverseFlashcardInfo);
            }
            else {
                this.reverseFlashcard.populateNewFlashcard('reverse', this.name, this.rawDefinition(), this.imageTag(), true);
            }
            this.reverseFlashcard.populateFromExistingFlashcard('reverse', this.name, this.reverseFlashcardInfo);
        }
        else if (this.createReverseFlashcard) {
            this.reverseFlashcard.populateNewFlashcard('reverse', this.name, this.rawDefinition(), this.imageTag(), false);
        }
    }
    writeToFile(filePath) {
        // If we have new flashcards or changed Atom data, we need to write to file
        if (this.basicFlashcard.isDirty() || this.reverseFlashcard.isDirty()) {
            // write to file
            console.log(`Updated ${this.name} with new Atom content`);
            fs.writeFileSync(filePath, this.generateAtomContent());
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXRvbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hdG9tL2F0b20udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDckMsT0FBTyxFQUFhLGVBQWUsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN6RCxPQUFPLEVBQXlCLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUN2RCxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQWF6QixNQUFNLE9BQU8sSUFBSyxTQUFRLEtBQUs7SUFVM0IsWUFBWSxFQVVXO1lBVlgsRUFDUixNQUFNLEdBQUcsRUFBRSxFQUNYLFVBQVUsR0FBRyxFQUFFLEVBQ2YsaUJBQWlCLEdBQUcsRUFBRSxFQUN0QixnQkFBZ0IsR0FBRyxFQUFFLEVBQ3JCLFdBQVcsR0FBRyxFQUFFLEVBQ2hCLFFBQVEsR0FBRyxFQUFFLEVBQ2IsZUFBZSxHQUFHLEVBQUUsRUFDcEIsUUFBUSxHQUFHLEVBQUUsT0FFTSxFQURoQixVQUFVLGNBVEwsMkhBVVgsQ0FEZ0I7UUFFYixLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDbEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO1FBQzNDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUN6QyxJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUMvQixJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztRQUN2QyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUM3QixDQUFDO0lBRUQsUUFBUTtRQUNKLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFD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QUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRBdG9tWWFtbCB9IGZyb20gJy4veWFtbCc7XG5pbXBvcnQgeyBGbGFzaGNhcmQsIEZsYXNoY2FyZFN0YXR1cyB9IGZyb20gJy4vZmxhc2hjYXJkJztcbmltcG9ydCB7IFF1YXJrQ29uc3RydWN0b3JQcm9wcywgUXVhcmsgfSBmcm9tICcuL3F1YXJrJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcblxuaW50ZXJmYWNlIEF0b21Db25zdHJ1Y3RvclByb3BzIGV4dGVuZHMgUXVhcmtDb25zdHJ1Y3RvclByb3Bze1xuICAgIHRvcGljcz86IHN0cmluZ1tdO1xuICAgIHJlZmVyZW5jZXM/OiBzdHJpbmdbXTtcbiAgICBmdXJ0aGVyRGVmaW5pdGlvbj86IHN0cmluZztcbiAgICBpbnRlcmVzdGluZ0ZhY3RzPzogc3RyaW5nO1xuICAgIGtleUNvbmNlcHRzPzogc3RyaW5nO1xuICAgIG1ldGFwaG9yPzogc3RyaW5nO1xuICAgIGZ1cnRoZXJSZXNlYXJjaD86IHN0cmluZztcbiAgICBpbWFnZVJlZj86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEF0b20gZXh0ZW5kcyBRdWFyayB7XG4gICAgdG9waWNzOiBzdHJpbmdbXTtcbiAgICByZWZlcmVuY2VzOiBzdHJpbmdbXTtcbiAgICBmdXJ0aGVyRGVmaW5pdGlvbjogc3RyaW5nO1xuICAgIGludGVyZXN0aW5nRmFjdHM6IHN0cmluZztcbiAgICBrZXlDb25jZXB0czogc3RyaW5nO1xuICAgIG1ldGFwaG9yOiBzdHJpbmc7XG4gICAgZnVydGhlclJlc2VhcmNoOiBzdHJpbmc7XG4gICAgaW1hZ2VSZWY6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKHtcbiAgICAgICAgdG9waWNzID0gW10sXG4gICAgICAgIHJlZmVyZW5jZXMgPSBbXSxcbiAgICAgICAgZnVydGhlckRlZmluaXRpb24gPSAnJyxcbiAgICAgICAgaW50ZXJlc3RpbmdGYWN0cyA9ICcnLFxuICAgICAgICBrZXlDb25jZXB0cyA9ICcnLFxuICAgICAgICBtZXRhcGhvciA9ICcnLFxuICAgICAgICBmdXJ0aGVyUmVzZWFyY2ggPSAnJyxcbiAgICAgICAgaW1hZ2VSZWYgPSAnJyxcbiAgICAgICAgLi4ucXVhcmtQcm9wc1xuICAgIH06IEF0b21Db25zdHJ1Y3RvclByb3BzKSB7XG4gICAgICAgIHN1cGVyKHF1YXJrUHJvcHMpO1xuICAgICAgICB0aGlzLnRvcGljcyA9IHRvcGljcztcbiAgICAgICAgdGhpcy5yZWZlcmVuY2VzID0gcmVmZXJlbmNlcztcbiAgICAgICAgdGhpcy5mdXJ0aGVyRGVmaW5pdGlvbiA9IGZ1cnRoZXJEZWZpbml0aW9uO1xuICAgICAgICB0aGlzLmludGVyZXN0aW5nRmFjdHMgPSBpbnRlcmVzdGluZ0ZhY3RzO1xuICAgICAgICB0aGlzLmtleUNvbmNlcHRzID0ga2V5Q29uY2VwdHM7XG4gICAgICAgIHRoaXMuZnVydGhlclJlc2VhcmNoID0gZnVydGhlclJlc2VhcmNoO1xuICAgICAgICB0aGlzLm1ldGFwaG9yID0gbWV0YXBob3I7XG4gICAgICAgIHRoaXMuaW1hZ2VSZWYgPSBpbWFnZVJlZjtcbiAgICB9XG5cbiAgICBpbWFnZVRhZygpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5pbWFnZVJlZiA/IGAhWyR7dGhpcy5uYW1lfV0oJHt0aGlzLmltYWdlUmVmfSlgIDogJyc7XG4gICAgfVxuXG5cbiAgICBnZW5lcmF0ZUF0b21Db250ZW50KCk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGZsYXNoY2FyZFNlY3Rpb24gPSB0aGlzLmJhc2ljRmxhc2hjYXJkLmdlbmVyYXRlRmxhc2hjYXJkU2VjdGlvbignYmFzaWMnKTtcbiAgICAgICAgY29uc3QgcmV2ZXJzZUZsYXNoY2FyZFNlY3Rpb24gPSB0aGlzLnJldmVyc2VGbGFzaGNhcmQuZ2VuZXJhdGVGbGFzaGNhcmRTZWN0aW9uKCdyZXZlcnNlJyk7XG4gICAgICAgIGxldCBpbWFnZVRhZyA9IHRoaXMuaW1hZ2VUYWcoKVxuICAgICAgICBsZXQgY29udGVudCA9IGAke3RoaXMuZnJvbnRtYXR0ZXIoKX0ke3RoaXMuZGVmaW5pdGlvbn0tLS1cXG4ke2ltYWdlVGFnfVxcbiR7dGhpcy5mdXJ0aGVyRGVmaW5pdGlvbn1cXG5cXG4ke3RoaXMuaW50ZXJlc3RpbmdGYWN0c31cXG5cXG4ke3RoaXMua2V5Q29uY2VwdHN9XFxuXFxuJHt0aGlzLm1ldGFwaG9yfVxcblxcbiR7dGhpcy5mdXJ0aGVyUmVzZWFyY2h9XFxuYDtcbiAgICAgICAgaWYgKHRoaXMuY3JlYXRlRmxhc2hjYXJkKSB7XG4gICAgICAgICAgICBjb250ZW50ID0gY29udGVudCArIGZsYXNoY2FyZFNlY3Rpb247XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuY3JlYXRlUmV2ZXJzZUZsYXNoY2FyZCkge1xuICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnQgKyAnXFxuXFxuLS0tXFxuXFxuJyArIHJldmVyc2VGbGFzaGNhcmRTZWN0aW9uO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgfVxuICAgIGV4dHJhY3RJbWFnZVVybChjb250ZW50OiBzdHJpbmcpOiBzdHJpbmcgfCBudWxsIHtcbiAgICAgICAgY29uc3QgaW1hZ2VSZWdleCA9IC8hXFxbLio/XFxdXFwoKGh0dHBzPzpcXC9cXC9bXlxccyldKylcXCkvO1xuICAgICAgICBjb25zdCBtYXRjaCA9IGNvbnRlbnQubWF0Y2goaW1hZ2VSZWdleCk7XG4gICAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogbnVsbDtcbiAgICB9XG5cbi8qICAgICBnZW5lcmF0ZVJldmVyc2VGbGFzaGNhcmRTZWN0aW9uKCk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHJhd0RlZmluaXRpb24gPSB0aGlzLnJhd0RlZmluaXRpb24oKS50cmltKClcbiAgICAgICAgcmV0dXJuIGBcXG4jIyMjIyAke3RoaXMubmFtZX0tUmV2ZXJzZSAjZmxhc2hjYXJkL3JldmVyc2UgXFxuU1RBUlRcXG5CYXNpY1xcbiR7cmF3RGVmaW5pdGlvbn1cXG5CYWNrOlxcbiR7dGhpcy5uYW1lfVxcblxcblRBUkdFVCBERUNLOiBCcmFpbjo6QXRvbXM6OlJldmVyc2VgO1xuICAgIH0gKi9cblxuICAgIGlzRGlydHkoKTogYm9vbGVhbiB7XG4gICAgICAgIGxldCBpc0RpcnR5ID0gZmFsc2U7XG4gICAgICAgIC8vIElmIHRoZSBkZWZpbml0aW9uIG9yIG5hbWUgaGFzIGNoYW5nZWQsIHdlIG5lZWQgdG8gdXBkYXRlXG4gICAgICAgIGlmICgodGhpcy5jcmVhdGVGbGFzaGNhcmQgfHwgdGhpcy5jcmVhdGVSZXZlcnNlRmxhc2hjYXJkKSAmJiAoIXRoaXMuZmxhc2hjYXJkSW5mby5pbmNsdWRlcyh0aGlzLnJhd0RlZmluaXRpb24oKSkgfHwgKHRoaXMuYmFzaWNGbGFzaGNhcmQubmFtZSAhPSB0aGlzLm5hbWUpKSkge1xuICAgICAgICAgICAgaXNEaXJ0eSA9IHRydWU7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgZGlydHkgY2hlY2s6ICR7dGhpcy5mbGFzaGNhcmRJbmZvLmluY2x1ZGVzKHRoaXMucmF3RGVmaW5pdGlvbigpLnRyaW1TdGFydCgpLnRyaW1FbmQoKSl9YCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmZsYXNoY2FyZEluZm8uaW5kZXhPZih0aGlzLnJhd0RlZmluaXRpb24oKS50cmltU3RhcnQoKS50cmltRW5kKCkpKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMuZmxhc2hjYXJkSW5mbyk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLnJhd0RlZmluaXRpb24oKS50cmltU3RhcnQoKS50cmltRW5kKCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGlzRGlydHk7XG4gICAgfVxuXG4gICAgZnJvbnRtYXR0ZXIoKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IHRvcGljcyA9ICcnO1xuICAgICAgICBsZXQgcmVmZXJlbmNlcyA9ICcnO1xuICAgICAgICBpZiAodGhpcy50b3BpY3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdGhpcy50b3BpY3MuZm9yRWFjaChlbGVtZW50ID0+IHsgXG4gICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5pbmNsdWRlcygnW1snKSAmJiBlbGVtZW50LmluY2x1ZGVzKCddXScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LmluY2x1ZGVzKCdcIicpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gYCcke2VsZW1lbnR9J2BcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBgXCIke2VsZW1lbnR9XCJgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0b3BpY3MgKz0gYFxcbi0gJHtlbGVtZW50fWAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucmVmZXJlbmNlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLnJlZmVyZW5jZXMuZm9yRWFjaChlbGVtZW50ID0+IHsgXG4gICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudC5pbmNsdWRlcygnW1snKSAmJiBlbGVtZW50LmluY2x1ZGVzKCddXScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbGVtZW50LmluY2x1ZGVzKCdcIicpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gYCcke2VsZW1lbnR9J2BcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsZW1lbnQgPSBgXCIke2VsZW1lbnR9XCJgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVmZXJlbmNlcyArPSBgXFxuLSAke2VsZW1lbnR9YFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIHJldHVybiBgLS0tXFxubmFtZTogJHt0aGlzLm5hbWV9XFxudHlwZTogJHt0aGlzLnR5cGV9XFxudG9waWNzOiAke3RvcGljc31cXG5yZWZlcmVuY2VzOiAke3JlZmVyZW5jZXN9XFxuY3JlYXRlRmxhc2hjYXJkOiAke3RoaXMuY3JlYXRlRmxhc2hjYXJkfVxcbmNyZWF0ZVJldmVyc2VGbGFzaGNhcmQ6ICR7dGhpcy5jcmVhdGVSZXZlcnNlRmxhc2hjYXJkfVxcbi0tLWA7XG4gICAgfVxuXG4gICAgcG9wdWxhdGVGcm9tRmlsZShmaWxlTmFtZTogc3RyaW5nLCBmaWxlQ29udGVudDogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIC8vIFBvcHVsYXRlIGZyb250bWF0dGVyIHByb3BlcnRpZXNcbiAgICAgICAgY29uc3QgeWFtbERhdGEgPSBnZXRBdG9tWWFtbChmaWxlQ29udGVudCk7XG4gICAgICAgIHRoaXMubmFtZSA9IGZpbGVOYW1lLnNwbGl0KCcuJylbMF07XG4gICAgICAgIHRoaXMudHlwZSA9ICh5YW1sRGF0YSA9PT0gbnVsbCB8fCB5YW1sRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogeWFtbERhdGEudHlwZSkgfHwgJyc7XG4gICAgICAgIHRoaXMudG9waWNzID0gKHlhbWxEYXRhID09PSBudWxsIHx8IHlhbWxEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiB5YW1sRGF0YS50b3BpY3MpIHx8IFtdO1xuICAgICAgICB0aGlzLnJlZmVyZW5jZXMgPSAoeWFtbERhdGEgPT09IG51bGwgfHwgeWFtbERhdGEgPT09IHZvaWQgMCA/IHZvaWQgMCA6IHlhbWxEYXRhLnJlZmVyZW5jZXMpIHx8IFtdO1xuICAgICAgICB0aGlzLmNyZWF0ZUZsYXNoY2FyZCA9ICh5YW1sRGF0YSA9PT0gbnVsbCB8fCB5YW1sRGF0YSA9PT0gdm9pZCAwID8gdm9pZCAwIDogeWFtbERhdGEuY3JlYXRlRmxhc2hjYXJkKSB8fCBmYWxzZTtcbiAgICAgICAgdGhpcy5jcmVhdGVSZXZlcnNlRmxhc2hjYXJkID0gKHlhbWxEYXRhID09PSBudWxsIHx8IHlhbWxEYXRhID09PSB2b2lkIDAgPyB2b2lkIDAgOiB5YW1sRGF0YS5jcmVhdGVSZXZlcnNlRmxhc2hjYXJkKSB8fCBmYWxzZTtcbiAgICAgICBcbiAgICAgICAgLy8gUG9wdWxhdGUgbWFpbiBjb250ZW50IHNlY3Rpb25zXG4gICAgICAgIGNvbnN0IHNlY3Rpb25zID0gZmlsZUNvbnRlbnQuc3BsaXQoXCJcXG4jIyBcIik7XG4gICAgICAgIHRoaXMuZGVmaW5pdGlvbiA9IHNlY3Rpb25zWzBdLnNwbGl0KCctLS0nKVsyXSB8fCAnJztcbiAgICAgICAgdGhpcy5mdXJ0aGVyRGVmaW5pdGlvbiA9IGAjIyAke3RoaXMucmVtb3ZlU3VjY2Vzc2l2ZU5ld2xpbmVzKHNlY3Rpb25zWzFdKX1gIHx8ICcnO1xuICAgICAgICB0aGlzLmludGVyZXN0aW5nRmFjdHMgPSBgIyMgJHt0aGlzLnJlbW92ZVN1Y2Nlc3NpdmVOZXdsaW5lcyhzZWN0aW9uc1syXSl9YCB8fCAnJztcbiAgICAgICAgdGhpcy5rZXlDb25jZXB0cyA9IGAjIyAke3RoaXMucmVtb3ZlU3VjY2Vzc2l2ZU5ld2xpbmVzKHNlY3Rpb25zWzNdKX1gIHx8ICcnO1xuICAgICAgICB0aGlzLm1ldGFwaG9yID0gYCMjICR7dGhpcy5yZW1vdmVTdWNjZXNzaXZlTmV3bGluZXMoc2VjdGlvbnNbNF0pfWAgfHwgJyc7XG4gICAgICAgIGlmIChmaWxlQ29udGVudC5pbmNsdWRlcygnI2ZsYXNoY2FyZCcpKSB7XG4gICAgICAgICAgICB0aGlzLmZ1cnRoZXJSZXNlYXJjaCA9IGAjIyAke3RoaXMucmVtb3ZlU3VjY2Vzc2l2ZU5ld2xpbmVzKHNlY3Rpb25zWzVdLnNwbGl0KCcjIyMjIyMnKVswXSl9YCB8fCAnJztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZnVydGhlclJlc2VhcmNoID0gYCMjICR7c2VjdGlvbnNbNV19YCB8fCAnJztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmltYWdlUmVmID0gdGhpcy5leHRyYWN0SW1hZ2VVcmwoZmlsZUNvbnRlbnQpIHx8ICcnO1xuICAgICAgICBcbiAgICAgICAgLy8gUG9wdWxhdGUgZmxhc2hjYXJkIHNlY3Rpb25zXG4gICAgICAgIGNvbnN0IGZsYXNoY2FyZFNlY3Rpb24gPSBzZWN0aW9uc1s1XTtcbiAgICAgICAgXG4gICAgICAgIC8vIEJhc2ljIEZsYXNoY2FyZFxuICAgICAgICB0aGlzLmZsYXNoY2FyZEluZm8gPSBmbGFzaGNhcmRTZWN0aW9uLnNwbGl0KCcjIyMjIyMnKVsxXVxuICAgICAgICBpZiAodGhpcy5mbGFzaGNhcmRJbmZvKSB7XG4gICAgICAgICAgICBjb25zdCBmbGFzaGNhcmREZWZpbml0aW9uID0gdGhpcy5iYXNpY0ZsYXNoY2FyZC5nZXRGbGFzaGNhcmRCYWNrKHRoaXMuZmxhc2hjYXJkSW5mbykucmVwbGFjZSh0aGlzLmltYWdlVGFnKCksICcnKS50cmltKCk7XG4gICAgICAgICAgICBpZiAoZmxhc2hjYXJkRGVmaW5pdGlvbiA9PSB0aGlzLnJhd0RlZmluaXRpb24oKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzaWNGbGFzaGNhcmQuc3RhdHVzID0gRmxhc2hjYXJkU3RhdHVzLk5PX0NIQU5HRTtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2ljRmxhc2hjYXJkLnBvcHVsYXRlRnJvbUV4aXN0aW5nRmxhc2hjYXJkKCdiYXNpYycsIHRoaXMubmFtZSwgdGhpcy5mbGFzaGNhcmRJbmZvKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuYmFzaWNGbGFzaGNhcmQuc3RhdHVzID0gRmxhc2hjYXJkU3RhdHVzLkNIQU5HRTtcbiAgICAgICAgICAgICAgICB0aGlzLmJhc2ljRmxhc2hjYXJkLnBvcHVsYXRlTmV3Rmxhc2hjYXJkKCdiYXNpYycsIHRoaXMubmFtZSwgdGhpcy5yYXdEZWZpbml0aW9uKCksIHRoaXMuaW1hZ2VUYWcoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh0aGlzLmNyZWF0ZUZsYXNoY2FyZCkge1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhgJHt0aGlzLm5hbWV9IGRvZXMgbm90IGhhdmUgYSBiYXNpYyBmbGFzaGNhcmRgKTtcbiAgICAgICAgICAgIHRoaXMuYmFzaWNGbGFzaGNhcmQucG9wdWxhdGVOZXdGbGFzaGNhcmQoJ2Jhc2ljJywgdGhpcy5uYW1lLCB0aGlzLnJhd0RlZmluaXRpb24oKSwgdGhpcy5pbWFnZVRhZygpLCBmYWxzZSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBSZXZlcnNlIEZsYXNoY2FyZFxuICAgICAgICB0aGlzLnJldmVyc2VGbGFzaGNhcmRJbmZvID0gZmxhc2hjYXJkU2VjdGlvbi5zcGxpdCgnLS0tJylbMl07XG4gICAgICAgIGlmICh0aGlzLnJldmVyc2VGbGFzaGNhcmRJbmZvKSB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuYmFzaWNGbGFzaGNhcmQuaXNEaXJ0eSgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXZlcnNlRmxhc2hjYXJkLnBvcHVsYXRlRnJvbUV4aXN0aW5nRmxhc2hjYXJkKCdyZXZlcnNlJywgdGhpcy5uYW1lLCB0aGlzLnJldmVyc2VGbGFzaGNhcmRJbmZvKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMucmV2ZXJzZUZsYXNoY2FyZC5wb3B1bGF0ZU5ld0ZsYXNoY2FyZCgncmV2ZXJzZScsIHRoaXMubmFtZSwgdGhpcy5yYXdEZWZpbml0aW9uKCksIHRoaXMuaW1hZ2VUYWcoKSwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLnJldmVyc2VGbGFzaGNhcmQucG9wdWxhdGVGcm9tRXhpc3RpbmdGbGFzaGNhcmQoJ3JldmVyc2UnLCB0aGlzLm5hbWUsIHRoaXMucmV2ZXJzZUZsYXNoY2FyZEluZm8pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKHRoaXMuY3JlYXRlUmV2ZXJzZUZsYXNoY2FyZCkge1xuICAgICAgICAgICAgdGhpcy5yZXZlcnNlRmxhc2hjYXJkLnBvcHVsYXRlTmV3Rmxhc2hjYXJkKCdyZXZlcnNlJywgdGhpcy5uYW1lLCB0aGlzLnJhd0RlZmluaXRpb24oKSwgdGhpcy5pbWFnZVRhZygpLCBmYWxzZSk7XG4gICAgICAgIH1cblxuICAgIH1cblxuXG4gICAgd3JpdGVUb0ZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICAvLyBJZiB3ZSBoYXZlIG5ldyBmbGFzaGNhcmRzIG9yIGNoYW5nZWQgQXRvbSBkYXRhLCB3ZSBuZWVkIHRvIHdyaXRlIHRvIGZpbGVcbiAgICAgICAgaWYgKHRoaXMuYmFzaWNGbGFzaGNhcmQuaXNEaXJ0eSgpIHx8IHRoaXMucmV2ZXJzZUZsYXNoY2FyZC5pc0RpcnR5KCkpIHtcbiAgICAgICAgICAgIC8vIHdyaXRlIHRvIGZpbGVcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBVcGRhdGVkICR7dGhpcy5uYW1lfSB3aXRoIG5ldyBBdG9tIGNvbnRlbnRgKTtcbiAgICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMoZmlsZVBhdGgsIHRoaXMuZ2VuZXJhdGVBdG9tQ29udGVudCgpKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==