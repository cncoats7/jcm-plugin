import { __awaiter } from "tslib";
import OpenAIApi from "openai";
import { DynamoDBClient } from '@aws-sdk/client-dynamodb';
import { ExecuteStatementCommand, ScanCommand, UpdateCommand, DynamoDBDocumentClient, PutCommand } from "@aws-sdk/lib-dynamodb";
import { v4 as uuidv4 } from 'uuid';
import { JCM_DEFAULT_SETTINGS } from './settings';
import { Atom } from './atom/atom';
import { Proton } from './atom/proton';
import * as fs from 'fs';
const getDynamoDBClient = () => __awaiter(void 0, void 0, void 0, function* () {
    const client = new DynamoDBClient({
        region: JCM_DEFAULT_SETTINGS.awsRegion,
        credentials: {
            accessKeyId: JCM_DEFAULT_SETTINGS.awsAccessKey,
            secretAccessKey: JCM_DEFAULT_SETTINGS.awsSecretKey
        }
    });
    return client;
});
const getDynamoDBDocumentClient = () => __awaiter(void 0, void 0, void 0, function* () {
    const client = yield getDynamoDBClient();
    const docClient = DynamoDBDocumentClient.from(client);
    return docClient;
});
const updateLastUsedDateForQuote = (docClient, quote_id, author, new_last_used_date) => __awaiter(void 0, void 0, void 0, function* () {
    const updateCommand = new UpdateCommand({
        TableName: JCM_DEFAULT_SETTINGS.awsDynamoDBQuoteTable,
        Key: {
            quote_id: quote_id,
            author: author
        },
        UpdateExpression: 'SET #last_used_date = :currentDate',
        ExpressionAttributeNames: {
            '#last_used_date': 'last_used_date'
        },
        ExpressionAttributeValues: {
            ':currentDate': new_last_used_date,
        },
        ReturnValues: 'ALL_NEW'
    });
    const executeUpdateCommand = new ExecuteStatementCommand({
        Statement: 'UPDATE ' + JCM_DEFAULT_SETTINGS.awsDynamoDBQuoteTable + ' SET last_used_date=? WHERE quote_id=? AND author=?',
        Parameters: [new_last_used_date, quote_id, author],
    });
    const updateResult = yield docClient.send(updateCommand);
    console.log("DynamoDBDocClient.send(UpdateCommand) Result:", updateResult);
});
export const addQuote = (quote, author) => __awaiter(void 0, void 0, void 0, function* () {
    const client = yield getDynamoDBDocumentClient();
    const created_at = Math.round(Date.now() / 1000);
    const tableName = 'quotes';
    const params = {
        TableName: tableName,
        Item: {
            quote_id: uuidv4(),
            created_at: created_at,
            quote: quote,
            author: author
        }
    };
    client.send(new PutCommand(params));
});
export const getRandomQuote = () => __awaiter(void 0, void 0, void 0, function* () {
    const tableName = JCM_DEFAULT_SETTINGS.awsDynamoDBQuoteTable;
    const thresholdDate = new Date();
    thresholdDate.setDate(thresholdDate.getDate() - JCM_DEFAULT_SETTINGS.vaultQuoteThresholdInDays);
    const command = new ScanCommand({
        TableName: tableName,
    });
    try {
        const docClient = yield getDynamoDBDocumentClient();
        const data = yield docClient.send(command);
        console.log("Scan Result:", data);
        if (data.Items && data.Items.length > 0) {
            const quotes = data.Items.filter(quote => quote.last_used_date === undefined || new Date(quote.last_used_date) < thresholdDate);
            console.log("Filtered Quotes:", quotes);
            const randomIndex = Math.floor(Math.random() * quotes.length);
            const randomQuote = quotes[randomIndex];
            const new_last_used_date = new Date().toISOString();
            console.log('Updating quote_id: ' + randomQuote.quote_id + 'author: ' + randomQuote.author + ' with last_used_date: ' + new_last_used_date);
        }
    }
    catch (err) {
        console.log("Error", err);
    }
});
export const getAISummary = (textToSummarize) => __awaiter(void 0, void 0, void 0, function* () {
    const openai = new OpenAIApi({
        apiKey: JCM_DEFAULT_SETTINGS.azureOpenAIKey,
    });
    const prompt = JCM_DEFAULT_SETTINGS.atomPrompt + textToSummarize;
    const response = yield openai.chat.completions.create({
        model: JCM_DEFAULT_SETTINGS.azureOpenAIDeployment,
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.9,
        max_tokens: 100, // Adjust max tokens as needed
    });
    return response.choices[0].message.content;
});
export const addReverseFlashcards = (environment) => __awaiter(void 0, void 0, void 0, function* () {
    const filePath = (environment === 'test') ? JCM_DEFAULT_SETTINGS.testAtomPath : JCM_DEFAULT_SETTINGS.atomPath;
    const fileName = filePath.split('/').pop() || '';
    const fileContent = fs.readFileSync(filePath, 'utf8');
    const atom = new Atom({});
    atom.populateFromFile(fileName, fileContent);
    const reverseFlashcard = atom.generateReverseFlashcardSection();
    fs.appendFileSync(filePath, reverseFlashcard, 'utf8');
});
export const updateAtom = (atomFilePath) => __awaiter(void 0, void 0, void 0, function* () {
    const fileContent = fs.readFileSync(atomFilePath, 'utf8');
    const atom = new Atom({});
    const fileName = atomFilePath.split('/').pop() || '';
    console.log('##############');
    console.log(fileName);
    atom.populateFromFile(fileName, fileContent);
    atom.writeToFile(atomFilePath);
});
export const updateAllAtoms = (environment) => __awaiter(void 0, void 0, void 0, function* () {
    const filePath = (environment === 'test') ? JCM_DEFAULT_SETTINGS.testAtomPath : JCM_DEFAULT_SETTINGS.atomPath;
    let counter = 0;
    fs.readdir(filePath, (err, files) => {
        if (err) {
            console.error(err);
            return;
        }
        files.forEach(file => {
            let atomFilePath = `${filePath}/${file}`;
            //console.log(atomFilePath);
            fs.stat(atomFilePath, (err, stats) => {
                if (err) {
                    console.error('Error getting stats:', err);
                    return;
                }
                if (!stats.isFile()) {
                    return;
                }
                else {
                    updateAtom(atomFilePath);
                }
            });
        });
    });
});
export const updateProton = (protonFilePath) => __awaiter(void 0, void 0, void 0, function* () {
    const fileContent = fs.readFileSync(protonFilePath, 'utf8');
    const proton = new Proton({});
    const fileName = protonFilePath.split('/').pop() || '';
    console.log('##############');
    console.log(fileName);
    proton.populateFromFile(fileName, fileContent);
    proton.writeToFile(protonFilePath);
});
export const updateAllProtons = (environment) => __awaiter(void 0, void 0, void 0, function* () {
    const filePath = (environment === 'test') ? JCM_DEFAULT_SETTINGS.testProtonPath : JCM_DEFAULT_SETTINGS.protonPath;
    let counter = 0;
    fs.readdir(filePath, (err, files) => {
        if (err) {
            console.error(err);
            return;
        }
        files.forEach(file => {
            let protonFilePath = `${filePath}/${file}`;
            //console.log(atomFilePath);
            fs.stat(protonFilePath, (err, stats) => {
                if (err) {
                    console.error('Error getting stats:', err);
                    return;
                }
                if (!stats.isFile()) {
                    return;
                }
                else {
                    updateProton(protonFilePath);
                }
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiamNtLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2pjbS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxTQUFTLE1BQU0sUUFBUSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxzQkFBc0IsRUFBRSxVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNoSSxPQUFPLEVBQUUsRUFBRSxJQUFJLE1BQU0sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDbEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVuQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZDLE9BQU8sS0FBSyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBRXpCLE1BQU0saUJBQWlCLEdBQUcsR0FBUSxFQUFFO0lBQ2hDLE1BQU0sTUFBTSxHQUFHLElBQUksY0FBYyxDQUFDO1FBQzlCLE1BQU0sRUFBRSxvQkFBb0IsQ0FBQyxTQUFTO1FBQ3RDLFdBQVcsRUFBRTtZQUNULFdBQVcsRUFBRSxvQkFBb0IsQ0FBQyxZQUFZO1lBQzlDLGVBQWUsRUFBRSxvQkFBb0IsQ0FBQyxZQUFZO1NBQ3JEO0tBQ0osQ0FBQyxDQUFDO0lBQ0gsT0FBTyxNQUFNLENBQUM7QUFDbEIsQ0FBQyxDQUFBLENBQUE7QUFFRCxNQUFNLHlCQUF5QixHQUFHLEdBQVEsRUFBRTtJQUN4QyxNQUFNLE1BQU0sR0FBRyxNQUFNLGlCQUFpQixFQUFFLENBQUE7SUFDeEMsTUFBTSxTQUFTLEdBQUcsc0JBQXNCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRXRELE9BQU8sU0FBUyxDQUFDO0FBQ3JCLENBQUMsQ0FBQSxDQUFBO0FBRUQsTUFBTSww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R0FBRyxHQUFHLFFBQVEsSUFBSSxJQUFJLEVBQUUsQ0FBQTtZQUMxQyw0QkFBNEI7WUFDNUIsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEVBQUU7Z0JBQ25DLElBQUksR0FBRyxFQUFFO29CQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQzNDLE9BQU87aUJBQ1Y7Z0JBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsRUFBRTtvQkFDakIsT0FBTztpQkFDVjtxQkFDSTtvQkFDRCxZQUFZLENBQUMsY0FBYyxDQUFDLENBQUM7aUJBQ2hDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFBLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgT3BlbkFJQXBpIGZyb20gXCJvcGVuYWlcIjtcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IEV4ZWN1dGVTdGF0ZW1lbnRDb21tYW5kLCBTY2FuQ29tbWFuZCwgVXBkYXRlQ29tbWFuZCwgRHluYW1vREJEb2N1bWVudENsaWVudCwgUHV0Q29tbWFuZCB9IGZyb20gXCJAYXdzLXNkay9saWItZHluYW1vZGJcIjtcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHsgSkNNX0RFRkFVTFRfU0VUVElOR1MgfSBmcm9tICcuL3NldHRpbmdzJztcbmltcG9ydCB7IEF0b20gfSBmcm9tICcuL2F0b20vYXRvbSc7XG5pbXBvcnQgeyBGbGFzaGNhcmQgfSBmcm9tICcuL2F0b20vZmxhc2hjYXJkJztcbmltcG9ydCB7IFByb3RvbiB9IGZyb20gJy4vYXRvbS9wcm90b24nO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnO1xuXG5jb25zdCBnZXREeW5hbW9EQkNsaWVudCA9IGFzeW5jKCkgPT4ge1xuICAgIGNvbnN0IGNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7XG4gICAgICAgIHJlZ2lvbjogSkNNX0RFRkFVTFRfU0VUVElOR1MuYXdzUmVnaW9uLFxuICAgICAgICBjcmVkZW50aWFsczoge1xuICAgICAgICAgICAgYWNjZXNzS2V5SWQ6IEpDTV9ERUZBVUxUX1NFVFRJTkdTLmF3c0FjY2Vzc0tleSxcbiAgICAgICAgICAgIHNlY3JldEFjY2Vzc0tleTogSkNNX0RFRkFVTFRfU0VUVElOR1MuYXdzU2VjcmV0S2V5XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gY2xpZW50O1xufVxuXG5jb25zdCBnZXREeW5hbW9EQkRvY3VtZW50Q2xpZW50ID0gYXN5bmMoKSA9PiB7XG4gICAgY29uc3QgY2xpZW50ID0gYXdhaXQgZ2V0RHluYW1vREJDbGllbnQoKVxuICAgIGNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShjbGllbnQpO1xuICAgIFxuICAgIHJldHVybiBkb2NDbGllbnQ7XG59XG5cbmNvbnN0IHVwZGF0ZUxhc3RVc2VkRGF0ZUZvclF1b3RlID0gYXN5bmMgKGRvY0NsaWVudDogRHluYW1vREJEb2N1bWVudENsaWVudCxxdW90ZV9pZDogc3RyaW5nLCBhdXRob3I6IHN0cmluZywgbmV3X2xhc3RfdXNlZF9kYXRlOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCB1cGRhdGVDb21tYW5kID0gbmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IEpDTV9ERUZBVUxUX1NFVFRJTkdTLmF3c0R5bmFtb0RCUXVvdGVUYWJsZSxcbiAgICAgICAgS2V5OiB7XG4gICAgICAgICAgICBxdW90ZV9pZDogcXVvdGVfaWQsXG4gICAgICAgICAgICBhdXRob3I6IGF1dGhvclxuICAgICAgICB9LFxuICAgICAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUICNsYXN0X3VzZWRfZGF0ZSA9IDpjdXJyZW50RGF0ZScsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICAgJyNsYXN0X3VzZWRfZGF0ZSc6ICdsYXN0X3VzZWRfZGF0ZSdcbiAgICAgICAgfSxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgJzpjdXJyZW50RGF0ZSc6IG5ld19sYXN0X3VzZWRfZGF0ZSxcbiAgICAgICAgfSxcbiAgICAgICAgUmV0dXJuVmFsdWVzOiAnQUxMX05FVydcbiAgICB9KTtcblxuICAgIGNvbnN0IGV4ZWN1dGVVcGRhdGVDb21tYW5kID0gbmV3IEV4ZWN1dGVTdGF0ZW1lbnRDb21tYW5kKHtcbiAgICAgICAgU3RhdGVtZW50OiAnVVBEQVRFICcgKyBKQ01fREVGQVVMVF9TRVRUSU5HUy5hd3NEeW5hbW9EQlF1b3RlVGFibGUgKyAnIFNFVCBsYXN0X3VzZWRfZGF0ZT0/IFdIRVJFIHF1b3RlX2lkPT8gQU5EIGF1dGhvcj0/JyxcbiAgICAgICAgUGFyYW1ldGVyczogW25ld19sYXN0X3VzZWRfZGF0ZSwgcXVvdGVfaWQsIGF1dGhvcl0sXG4gICAgfSk7XG5cbiAgICBjb25zdCB1cGRhdGVSZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZCh1cGRhdGVDb21tYW5kKTtcblx0Y29uc29sZS5sb2coXCJEeW5hbW9EQkRvY0NsaWVudC5zZW5kKFVwZGF0ZUNvbW1hbmQpIFJlc3VsdDpcIiwgdXBkYXRlUmVzdWx0KTtcdFx0XHRcdFx0XG59XG5cbmV4cG9ydCBjb25zdCBhZGRRdW90ZSA9IGFzeW5jKHF1b3RlOiBzdHJpbmcsIGF1dGhvcjogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgY2xpZW50ID0gYXdhaXQgZ2V0RHluYW1vREJEb2N1bWVudENsaWVudCgpO1xuICAgIGNvbnN0IGNyZWF0ZWRfYXQgPSBNYXRoLnJvdW5kKERhdGUubm93KCkgLyAxMDAwKTtcblx0XHRjb25zdCB0YWJsZU5hbWUgPSAncXVvdGVzJztcblx0XHRjb25zdCBwYXJhbXMgPSB7XG5cdFx0XHRUYWJsZU5hbWU6IHRhYmxlTmFtZSxcblx0XHRcdEl0ZW06IHtcblx0XHRcdFx0cXVvdGVfaWQ6IHV1aWR2NCgpLFxuXHRcdFx0XHRjcmVhdGVkX2F0OiBjcmVhdGVkX2F0LFxuXHRcdFx0XHRxdW90ZTogcXVvdGUsXG5cdFx0XHRcdGF1dGhvcjogYXV0aG9yXG5cdFx0XHR9XG5cdFx0fTtcblx0XHRjbGllbnQuc2VuZChuZXcgUHV0Q29tbWFuZChwYXJhbXMpKTtcbn1cbmV4cG9ydCBjb25zdCBnZXRSYW5kb21RdW90ZSA9IGFzeW5jICgpID0+IHtcbiAgICBjb25zdCB0YWJsZU5hbWUgPSBKQ01fREVGQVVMVF9TRVRUSU5HUy5hd3NEeW5hbW9EQlF1b3RlVGFibGVcbiAgICBjb25zdCB0aHJlc2hvbGREYXRlID0gbmV3IERhdGUoKTtcbiAgICB0aHJlc2hvbGREYXRlLnNldERhdGUodGhyZXNob2xkRGF0ZS5nZXREYXRlKCkgLSBKQ01fREVGQVVMVF9TRVRUSU5HUy52YXVsdFF1b3RlVGhyZXNob2xkSW5EYXlzKVxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICB9KTtcbiAgICB0cnkge1xuICAgICAgICBjb25zdCBkb2NDbGllbnQgPSBhd2FpdCBnZXREeW5hbW9EQkRvY3VtZW50Q2xpZW50KCk7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJTY2FuIFJlc3VsdDpcIiwgZGF0YSk7XG4gICAgICAgIGlmIChkYXRhLkl0ZW1zICYmIGRhdGEuSXRlbXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgcXVvdGVzID0gZGF0YS5JdGVtcy5maWx0ZXIoXG4gICAgICAgICAgICAgICAgcXVvdGUgPT4gcXVvdGUubGFzdF91c2VkX2RhdGUgPT09IHVuZGVmaW5lZCB8fCBuZXcgRGF0ZShxdW90ZS5sYXN0X3VzZWRfZGF0ZSkgPCB0aHJlc2hvbGREYXRlXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJGaWx0ZXJlZCBRdW90ZXM6XCIsIHF1b3Rlcyk7XG4gICAgICAgICAgICBjb25zdCByYW5kb21JbmRleCA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIHF1b3Rlcy5sZW5ndGgpO1xuICAgICAgICAgICAgY29uc3QgcmFuZG9tUXVvdGUgPSBxdW90ZXNbcmFuZG9tSW5kZXhdO1xuICAgICAgICAgICAgY29uc3QgbmV3X2xhc3RfdXNlZF9kYXRlID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1VwZGF0aW5nIHF1b3RlX2lkOiAnICsgcmFuZG9tUXVvdGUucXVvdGVfaWQgKyAnYXV0aG9yOiAnICsgcmFuZG9tUXVvdGUuYXV0aG9yICsgJyB3aXRoIGxhc3RfdXNlZF9kYXRlOiAnICsgbmV3X2xhc3RfdXNlZF9kYXRlKTtcbiAgICAgICAgfVxuICAgIH0gXG4gICAgY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkVycm9yXCIsIGVycik7XG4gICAgfVxufVxuXG5cbmV4cG9ydCBjb25zdCBnZXRBSVN1bW1hcnkgPSBhc3luYyAodGV4dFRvU3VtbWFyaXplOiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBvcGVuYWkgPSBuZXcgT3BlbkFJQXBpKHtcbiAgICAgICAgYXBpS2V5OiBKQ01fREVGQVVMVF9TRVRUSU5HUy5henVyZU9wZW5BSUtleSxcbiAgICB9KTtcbiAgICBcbiAgICBjb25zdCBwcm9tcHQgPSBKQ01fREVGQVVMVF9TRVRUSU5HUy5hdG9tUHJvbXB0ICsgdGV4dFRvU3VtbWFyaXplO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBvcGVuYWkuY2hhdC5jb21wbGV0aW9ucy5jcmVhdGUoe1xuICAgICAgICBtb2RlbDogSkNNX0RFRkFVTFRfU0VUVElOR1MuYXp1cmVPcGVuQUlEZXBsb3ltZW50LCAvLyBTcGVjaWZ5IHRoZSBkZXBsb3ltZW50IG5hbWVcbiAgICAgICAgbWVzc2FnZXM6IFt7IHJvbGU6ICd1c2VyJywgY29udGVudDogcHJvbXB0fV0sXG4gICAgICAgIHRlbXBlcmF0dXJlOiAwLjksXG4gICAgICAgIG1heF90b2tlbnM6IDEwMCwgLy8gQWRqdXN0IG1heCB0b2tlbnMgYXMgbmVlZGVkXG4gICAgfSk7XG5cbiAgICByZXR1cm4gcmVzcG9uc2UuY2hvaWNlc1swXS5tZXNzYWdlLmNvbnRlbnQ7XG59XG5cbmV4cG9ydCBjb25zdCBhZGRSZXZlcnNlRmxhc2hjYXJkcyA9IGFzeW5jIChlbnZpcm9ubWVudDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZmlsZVBhdGggPSAoZW52aXJvbm1lbnQgPT09ICd0ZXN0JykgPyBKQ01fREVGQVVMVF9TRVRUSU5HUy50ZXN0QXRvbVBhdGggOiBKQ01fREVGQVVMVF9TRVRUSU5HUy5hdG9tUGF0aDsgICAgXG4gICAgY29uc3QgZmlsZU5hbWUgPSBmaWxlUGF0aC5zcGxpdCgnLycpLnBvcCgpIHx8ICcnO1xuICAgIGNvbnN0IGZpbGVDb250ZW50ID0gZnMucmVhZEZpbGVTeW5jKGZpbGVQYXRoLCAndXRmOCcpXG4gICAgY29uc3QgYXRvbSA9IG5ldyBBdG9tKHt9KTtcbiAgICBhdG9tLnBvcHVsYXRlRnJvbUZpbGUoZmlsZU5hbWUsIGZpbGVDb250ZW50KTtcbiAgICBjb25zdCByZXZlcnNlRmxhc2hjYXJkID0gYXRvbS5nZW5lcmF0ZVJldmVyc2VGbGFzaGNhcmRTZWN0aW9uKCk7XG4gICAgZnMuYXBwZW5kRmlsZVN5bmMoZmlsZVBhdGgsIHJldmVyc2VGbGFzaGNhcmQsICd1dGY4Jyk7XG59XG5cbmV4cG9ydCBjb25zdCB1cGRhdGVBdG9tID0gYXN5bmMgKGF0b21GaWxlUGF0aDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZmlsZUNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMoYXRvbUZpbGVQYXRoLCAndXRmOCcpOyAgICBcbiAgICBjb25zdCBhdG9tID0gbmV3IEF0b20oe30pO1xuICAgIGNvbnN0IGZpbGVOYW1lID0gYXRvbUZpbGVQYXRoLnNwbGl0KCcvJykucG9wKCkgfHwgJyc7XG4gICAgY29uc29sZS5sb2coJyMjIyMjIyMjIyMjIyMjJylcbiAgICBjb25zb2xlLmxvZyhmaWxlTmFtZSk7XG4gICAgYXRvbS5wb3B1bGF0ZUZyb21GaWxlKGZpbGVOYW1lLCBmaWxlQ29udGVudCk7XG4gICAgYXRvbS53cml0ZVRvRmlsZShhdG9tRmlsZVBhdGgpO1xufVxuXG5leHBvcnQgY29uc3QgdXBkYXRlQWxsQXRvbXMgPSBhc3luYyAoZW52aXJvbm1lbnQ6IHN0cmluZykgPT4ge1xuICAgIGNvbnN0IGZpbGVQYXRoID0gKGVudmlyb25tZW50ID09PSAndGVzdCcpID8gSkNNX0RFRkFVTFRfU0VUVElOR1MudGVzdEF0b21QYXRoIDogSkNNX0RFRkFVTFRfU0VUVElOR1MuYXRvbVBhdGg7XG4gICAgbGV0IGNvdW50ZXIgPSAwO1xuICAgIGZzLnJlYWRkaXIoZmlsZVBhdGgsIChlcnIsIGZpbGVzKSA9PiB7XG4gICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgZmlsZXMuZm9yRWFjaChmaWxlID0+IHtcbiAgICAgICAgICAgIGxldCBhdG9tRmlsZVBhdGggPSBgJHtmaWxlUGF0aH0vJHtmaWxlfWBcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coYXRvbUZpbGVQYXRoKTtcbiAgICAgICAgICAgIGZzLnN0YXQoYXRvbUZpbGVQYXRoLCAoZXJyLCBzdGF0cykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2V0dGluZyBzdGF0czonLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghc3RhdHMuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlQXRvbShhdG9tRmlsZVBhdGgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuZXhwb3J0IGNvbnN0IHVwZGF0ZVByb3RvbiA9IGFzeW5jIChwcm90b25GaWxlUGF0aDogc3RyaW5nKSA9PiB7XG4gICAgY29uc3QgZmlsZUNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMocHJvdG9uRmlsZVBhdGgsICd1dGY4Jyk7ICAgIFxuICAgIGNvbnN0IHByb3RvbiA9IG5ldyBQcm90b24oe30pO1xuICAgIGNvbnN0IGZpbGVOYW1lID0gcHJvdG9uRmlsZVBhdGguc3BsaXQoJy8nKS5wb3AoKSB8fCAnJztcbiAgICBjb25zb2xlLmxvZygnIyMjIyMjIyMjIyMjIyMnKVxuICAgIGNvbnNvbGUubG9nKGZpbGVOYW1lKTtcbiAgICBwcm90b24ucG9wdWxhdGVGcm9tRmlsZShmaWxlTmFtZSwgZmlsZUNvbnRlbnQpO1xuICAgIHByb3Rvbi53cml0ZVRvRmlsZShwcm90b25GaWxlUGF0aCk7XG59XG5cbmV4cG9ydCBjb25zdCB1cGRhdGVBbGxQcm90b25zID0gYXN5bmMgKGVudmlyb25tZW50OiBzdHJpbmcpID0+IHtcbiAgICBjb25zdCBmaWxlUGF0aCA9IChlbnZpcm9ubWVudCA9PT0gJ3Rlc3QnKSA/IEpDTV9ERUZBVUxUX1NFVFRJTkdTLnRlc3RQcm90b25QYXRoIDogSkNNX0RFRkFVTFRfU0VUVElOR1MucHJvdG9uUGF0aDtcbiAgICBsZXQgY291bnRlciA9IDA7XG4gICAgZnMucmVhZGRpcihmaWxlUGF0aCwgKGVyciwgZmlsZXMpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBmaWxlcy5mb3JFYWNoKGZpbGUgPT4ge1xuICAgICAgICAgICAgbGV0IHByb3RvbkZpbGVQYXRoID0gYCR7ZmlsZVBhdGh9LyR7ZmlsZX1gXG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKGF0b21GaWxlUGF0aCk7XG4gICAgICAgICAgICBmcy5zdGF0KHByb3RvbkZpbGVQYXRoLCAoZXJyLCBzdGF0cykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgZ2V0dGluZyBzdGF0czonLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghc3RhdHMuaXNGaWxlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlUHJvdG9uKHByb3RvbkZpbGVQYXRoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59Il19